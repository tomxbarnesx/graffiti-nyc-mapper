<h1> NYC Graffiti Maps </h1>
<% if current_user %>
    <button id="add-button">Add New Piece</button>
<% end %>
<div id="map"></div>

<div id="form">
    <%= render "form" %>
</div>

<div id="message">Location saved</div>


<script async defer src="https://maps.googleapis.com/maps/api/js?key=<%=ENV['GMAPS_KEY']%>&callback=initMap"></script>
<script>
    var map, infoWindow, marker, messagewindow;

    function createMarker(coords, map, title){
        marker = new google.maps.Marker({
            position: coords,
            map: map,
            title: title
        });
    }

    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            center: {lat: 40.706684, lng: -73.923059},
            zoom: 15
        });
        infoWindow = new google.maps.InfoWindow;

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
            var pos = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };

            infoWindow.setPosition(pos);
            infoWindow.setContent('Location found.');
            infoWindow.open(map);
            map.setCenter(pos);
            }, function() {
            handleLocationError(true, infoWindow, map.getCenter());
            });
        } else {
            handleLocationError(false, infoWindow, map.getCenter());
        }

        var markers = [
            <% @pieces.each do |p|%>
                {
                    position:{lat: <%= p.lat %> ,lng:<%= p.lng %>},
                    map: map
                },
            <% end %>
        ];

        var contentStrings = [
            <% @pieces.each do |p|%>
                {
                    content: '<div class="displayContent"><div class="photoWrapper"> <%= image_tag p.photo, width: '350' %> </div></div>'
                },
            <% end %>
        ]

        var allWindows = []


        for (let i = 0; i < <%=@plength%>; i++){
            var infowindow = new google.maps.InfoWindow(contentStrings[i]);
            allWindows.push(infowindow);
            var marker = new google.maps.Marker(markers[i]);
            marker.infowindow = infowindow;
            marker.addListener('click', function() {
                return this.infowindow.open(map, this);
            });
        }

        google.maps.event.addListener(map, "click", function(event) {
            for (var i = 0; i < allWindows.length; i++ ) {
                allWindows[i].close();
            }
        });

        infowindow = new google.maps.InfoWindow({
            content: document.getElementById('form')
        });

        messagewindow = new google.maps.InfoWindow({
            content: document.getElementById('message')
        });
        
        var addToggle = false;
        var markerAdd;

        document.getElementById("add-button").addEventListener("click", () => {
            if (addToggle == false) {
                addToggle = true;
                console.log(addToggle);
                markerAdd = google.maps.event.addListener(map, 'click', function(event) {
                    marker = new google.maps.Marker({
                    position: event.latLng,
                    map: map});
        
                    google.maps.event.addListener(marker, 'click', function() {
                        infowindow.open(map, marker);
                        var latlng = marker.getPosition();
                        document.getElementById('lat').value = latlng.lat();
                        document.getElementById('lng').value = latlng.lng();
                    });
        
                    function handleLocationError(browserHasGeolocation, infoWindow, pos) {
                    infoWindow.setPosition(pos);
                    infoWindow.setContent(browserHasGeolocation ?
                                        'Error: The Geolocation service failed.' :
                                        'Error: Your browser doesn\'t support geolocation.');
                    infoWindow.open(map);
                        }

                    google.maps.event.addListener(map, "click", function(event) {
                        infowindow.close();
                    });
        });
            } else {
                addToggle = false;
                console.log(addToggle);
                google.maps.event.removeListener(markerAdd);
            }
        })
}

function saveData() {
  var name = escape(document.getElementById('name').value);
  var address = escape(document.getElementById('address').value);
  var type = document.getElementById('type').value;
  var latlng = marker.getPosition();
  var url = 'phpsqlinfo_addrow.php?name=' + name + '&address=' + address +
            '&type=' + type + '&lat=' + latlng.lat() + '&lng=' + latlng.lng();

  downloadUrl(url, function(data, responseCode) {

    if (responseCode == 200 && data.length <= 1) {
      infowindow.close();
      messagewindow.open(map, marker);
    }
  });
}

function downloadUrl(url, callback) {
  var request = window.ActiveXObject ?
      new ActiveXObject('Microsoft.XMLHTTP') :
      new XMLHttpRequest;

  request.onreadystatechange = function() {
    if (request.readyState == 4) {
      request.onreadystatechange = doNothing;
      callback(request.responseText, request.status);
    }
  };

  request.open('GET', url, true);
  request.send(null);
}

function doNothing () {
}
</script>
